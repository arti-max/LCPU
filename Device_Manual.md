### Документация по устройствам для LCPU

В этом документе описана работа с устройствами для 8-битного процессора LCPU. Устройства подключаются к портам процессора и взаимодействуют с ним через стандартизированный API. Каждое устройство должно быть реализовано как класс, наследующийся от базового класса `Device`, и должно соответствовать определённым требованиям.

---

## Структура устройства

Каждое устройство должно быть реализовано в отдельном файле, имя которого должно совпадать с именем класса (с учётом регистра). Например, устройство `LED` должно быть в файле `LED.py`.

### Основные требования к устройству:

1. **Наследование от `Device`**: Каждое устройство должно наследоваться от базового класса `Device`, который предоставляет базовый функционал для работы с процессором и конфигурацией.
2. **Реализация методов `IN` и `OUT`**: Эти методы обязательны для каждого устройства. Они используются для взаимодействия с процессором.
3. **Конфигурация**: Каждое устройство должно поддерживать конфигурацию через JSON-файл, который автоматически создаётся в папке `ino/conf/`.

---

## Базовый класс `Device`

Базовый класс `Device` предоставляет общий функционал для всех устройств. Он реализует методы для работы с конфигурацией, обработки событий, обновления состояния и отрисовки.

### Основные методы и атрибуты:

#### `__init__()`
Инициализация устройства. В этом методе задаются базовые атрибуты, такие как `_value`, `_surface`, `_rect`, `_config`, и другие. Также здесь можно задать специфичные для устройства настройки в `_device_config`.

#### `IN()`
Абстрактный метод, который должен быть реализован в каждом устройстве. Возвращает значение, которое устройство передаёт процессору.

#### `OUT(value)`
Абстрактный метод, который должен быть реализован в каждом устройстве. Принимает значение от процессора и обновляет состояние устройства.

#### `enable()`
Включает устройство. Устройство начинает обрабатывать события и обновлять своё состояние.

#### `disable()`
Выключает устройство. Устройство перестаёт обрабатывать события и обновлять своё состояние.

#### `is_enabled()`
Возвращает `True`, если устройство включено, и `False`, если выключено.

#### `set_update_rate(hz)`
Устанавливает частоту обновления устройства в герцах. Если `hz = 0`, устройство обновляется на каждом кадре.

#### `should_update()`
Проверяет, нужно ли обновлять устройство на текущем кадре, исходя из установленной частоты обновления.

#### `push_event(event_type, data=None)`
Добавляет событие в очередь устройства. События могут быть использованы для взаимодействия с процессором или другими устройствами.

#### `get_events()`
Возвращает все события из очереди устройства и очищает её.

#### `handle_event(event)`
Обрабатывает события Pygame, такие как клики мыши. Если устройство активно и событие происходит в пределах его области, вызывается метод `on_click`.

#### `on_click(event)`
Метод, который вызывается при клике по устройству. Может быть переопределён для реализации специфичного поведения.

#### `load_config(config_path)`
Загружает конфигурацию устройства из JSON-файла. Если файл не существует, создаётся новый с настройками по умолчанию.

#### `save_config(config_path)`
Сохраняет текущую конфигурацию устройства в JSON-файл.

#### `update()`
Обновляет состояние устройства. Этот метод вызывается на каждом кадре, если устройство включено и частота обновления позволяет.

#### `draw(screen)`
Отрисовывает устройство на экране. Если включён режим отладки, также отображает отладочную информацию.

#### `set_cpu(cpu)`
Устанавливает ссылку на процессор, чтобы устройство могло взаимодействовать с ним.

---

## Конфигурация устройств

Каждое устройство поддерживает конфигурацию через JSON-файл, который автоматически создаётся в папке `ino/conf/`. Имя файла должно совпадать с именем класса устройства. Например, для устройства `LED` конфигурация будет храниться в файле `ino/conf/LED.json`.

### Базовый конфиг

Базовый конфиг содержит следующие поля:

```json
{
    "position": {"x": 100, "y": 100},
    "size": 50,
    "visible": true,
    "enabled": true,
    "update_rate": 0,
    "debug": false
}
```

- **position**: Позиция устройства на экране.
- **size**: Размер устройства.
- **visible**: Видимость устройства.
- **enabled**: Включено ли устройство.
- **update_rate**: Частота обновления устройства в герцах.
- **debug**: Включён ли режим отладки.

### Расширение конфига

Каждое устройство может расширять базовый конфиг своими специфичными настройками. Например, устройство `LED` добавляет следующие поля:

```json
{
    "colors": {
        "on": [255, 50, 50],
        "off": [50, 0, 0],
        "glow": [255, 100, 100],
        "border": [80, 80, 80]
    },
    "size": 30,
    "border": 2,
    "glow_radius": 5,
    "position": {
        "x": 750,
        "y": 550
    }
}
```

---

## Пример устройства: LED

Устройство `LED` представляет собой светодиод, который может включаться и выключаться. Оно реализует методы `IN` и `OUT`, а также поддерживает конфигурацию через JSON-файл.

### Основные методы:

#### `IN()`
Возвращает текущее состояние светодиода: `0x01`, если светодиод включён, и `0x00`, если выключен.

#### `OUT(value)`
Устанавливает состояние светодиода. Если `value` не равно нулю, светодиод включается, иначе выключается.

#### `update()`
Обновляет отображение светодиода с эффектом свечения. Если светодиод включён, вокруг него рисуется свечение.

#### `load_config(config_path)`
Загружает конфигурацию светодиода и обновляет его размеры и позицию на экране.

#### `on_click(event)`
Обрабатывает клик по светодиоду. Если устройство кликабельно, состояние светодиода переключается.

---

## Подключение устройств

Устройства подключаются к портам процессора через файл `ino/ports.json`. В этом файле указывается, какое устройство подключено к какому порту. Например:

```json
{
    "0": "LED.py",
    "1": "Display.py",
    "2": "",
    "3": ""
}
```

- **0**: Устройство `LED` подключено к порту 0.
- **1**: Устройство `Display` подключено к порту 1.
- **2** и **3**: Порт 2 и 3 свободны.

---

## Заключение

Этот документ описывает базовый функционал для создания и подключения устройств к процессору LCPU. Каждое устройство должно быть реализовано как класс, наследующийся от `Device`, и должно поддерживать конфигурацию через JSON-файл. Пример устройства `LED` демонстрирует, как можно реализовать простое устройство с поддержкой всех необходимых методов.
